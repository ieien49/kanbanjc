const COLONNES_AFFICHAGE_DEFAUT=[{id:"üñêÔ∏è √Ä faire",libelle:"√Ä faire",couleur:"#f95c5e",btajout:!0,isdone:!1,useconfetti:!1},{id:"‚ôªÔ∏è En cours",libelle:"En cours",couleur:"#417DC4",btajout:!1,isdone:!1,useconfetti:!1},{id:"‚úÖ Fait",libelle:"Fait",couleur:"#27a658",btajout:!1,isdone:!0,useconfetti:!0},{id:"‚ùå Annul√©",libelle:"Annul√©",couleur:"#301717",btajout:!1,isdone:!0,useconfetti:!1}],DEADLINE_PRIORITE=new Date("3000-01-01");let COLONNES_AFFICHAGE;const TABLE_KANBAN=grist.getTable();let COLONNES_MAP,PERSONNES,PERSONNES_RAW,REF_PROJET,REF_PROJET_RAW,TYPES,TYPES_RAW,ROTATE_CARTE=!0,CARTE_COMPACT=!1,READ_ONLY=!1;function toggleColonne(e,t){t?.stopPropagation(),e.classList.toggle("collapsed"),localStorage.setItem(`column-todo-${e.querySelector(".titre-statut").textContent.trim()}`,e.classList.contains("collapsed"))}function triggerConfetti(){const e=Date.now()+3e3,t={startVelocity:30,spread:360,ticks:60,zIndex:0};function o(e,t){return Math.random()*(t-e)+e}const n=setInterval((function(){const a=e-Date.now();if(a<=0)return clearInterval(n);const l=a/3e3*50;confetti(Object.assign({},t,{particleCount:l,origin:{x:o(.1,.3),y:Math.random()-.2}})),confetti(Object.assign({},t,{particleCount:l,origin:{x:o(.7,.9),y:Math.random()-.2}}))}),250)}async function mettreAJourChamp(e,t,o,n){try{if(n?.stopPropagation(),t===COLONNES_MAP.STATUT){const e=COLONNES_AFFICHAGE.find((e=>e.id===o));e&&e.useconfetti&&triggerConfetti()}let a={[t]:o};COLONNES_MAP.DERNIERE_MISE_A_JOUR&&(a[COLONNES_MAP.DERNIERE_MISE_A_JOUR]=(new Date).toISOString()),await TABLE_KANBAN.update({id:parseInt(e),fields:a})}catch(e){console.error("Erreur mise √† jour:",e)}}function formatDate(e){if(!e)return"-";const t=new Date(e);if(t>=DEADLINE_PRIORITE)return null;return`${t.getDate().toString().padStart(2,"0")} ${t.toLocaleDateString("fr-FR",{month:"short"})} ${t.getFullYear()}`}function formatDateForInput(e){if(!e)return"";try{const t=new Date(e);return t>=DEADLINE_PRIORITE?"":t.toISOString().split("T")[0]}catch(e){return console.error("Erreur de formatage de date:",e),""}}function creerCarteTodo(e){const t=document.createElement("div");t.className=`carte ${ROTATE_CARTE?"":" norotate"}${CARTE_COMPACT?" compact":""}`,t.setAttribute("data-todo-id",e.id),t.setAttribute("data-last-update",e[COLONNES_MAP.DERNIERE_MISE_A_JOUR]||""),t.setAttribute("data-deadline",e[COLONNES_MAP.DEADLINE]||""),COLONNES_MAP.COULEUR&&e[COLONNES_MAP.COULEUR]&&t.setAttribute("style","background-color: "+((e[COLONNES_MAP.COULEUR].startsWith("#")?"":"#")+e[COLONNES_MAP.COULEUR]));const o=e[COLONNES_MAP.TYPE]||"",n=e[COLONNES_MAP.DESCRIPTION]||"Sans titre",a=e[COLONNES_MAP.DEADLINE]?formatDate(e[COLONNES_MAP.DEADLINE]):"",l=e[COLONNES_MAP.RESPONSABLE]||"",i=e[COLONNES_MAP.REFERENCE_PROJET],r=COLONNES_AFFICHAGE.find((t=>t.id===e[COLONNES_MAP.STATUT]));return t.innerHTML=`\n      ${i&&i.length>0?`<div class="projet-ref truncate">#${i}</div>`:""}\n      ${o?`<div class="type-tag truncate">${o}</div>`:i&&i.length>0?"<div>&nbsp;</div>":""}\n      <div class="description">${n}</div>\n      ${a?`<div class="deadline${e[COLONNES_MAP.DEADLINE]<Date.now()?" late":""} truncate">üìÖ ${a}</div>`:l?"<div>&nbsp;</div>":""}\n      ${l?`<div class="responsable-badge truncate">${l}</div>`:""}\n      ${r?.isdone?`<div class="tampon-termine" style="color: ${r?.couleur};">${e[COLONNES_MAP.STATUT]}</div>`:""}      \n    `,t.addEventListener("click",(()=>togglePopupTodo(e))),t}function creerColonneKanban(e){const t=document.createElement("div");t.className="colonne-kanban "+(e.btajout?"":"colonne-nobouton");return"true"===localStorage.getItem(`column-todo-${e.libelle}`)&&t.classList.add("collapsed"),t.innerHTML=`\n      <div class="entete-colonne" style="background-color: ${e.couleur}">\n        <div class="titre-statut">${e.libelle} <span class="compteur-colonne">(0)</span></div>\n        ${e.btajout&&!READ_ONLY?`\n          <button class="bouton-ajouter-entete ${CARTE_COMPACT?" compact":""}" onclick="creerNouvelleTache('${e.id}')">+</button>\n        `:""}\n        <button class="bouton-toggle" onclick="toggleColonne(this.closest('.colonne-kanban'), event)">‚áÑ</button>\n      </div>\n      ${e.btajout&&!READ_ONLY?`\n        <button class="bouton-ajouter ${CARTE_COMPACT?" compact":""}" onclick="creerNouvelleTache('${e.id}')">+ Ajouter une t√¢che</button>\n      `:""}\n      <div class="contenu-colonne" data-statut="${e.id}"></div>\n    `,t}function mettreAJourCompteur(e){const t=e.querySelector(".contenu-colonne"),o=e.querySelector(".compteur-colonne");t&&o&&(o.textContent=`(${t.children.length})`)}function trierTodo(e){const t=Array.from(e.children),o=e.dataset.isdone;t.sort(((e,t)=>{if(o){const o=e.getAttribute("data-last-update")||"1970-01-01",n=t.getAttribute("data-last-update")||"1970-01-01",a=new Date(n)-new Date(o);if(0===a){const o=parseInt(e.getAttribute("data-todo-id"))||0;return(parseInt(t.getAttribute("data-todo-id"))||0)-o}return a}{const o=e.getAttribute("data-deadline")||"9999-12-31",n=t.getAttribute("data-deadline")||"9999-12-31",a=new Date(o)-new Date(n);if(0===a){const o=parseInt(e.getAttribute("data-todo-id"))||0;return(parseInt(t.getAttribute("data-todo-id"))||0)-o}return a}})),t.forEach((t=>e.appendChild(t)))}function togglePopupTodo(e){const t=document.getElementById("popup-todo"),o=(t.dataset.currentTodo,document.querySelector(".carte.active")),n=document.querySelector(`[data-todo-id="${e.id}"]`),a=COLONNES_AFFICHAGE.find((t=>t.id===e[COLONNES_MAP.STATUT]));if(READ_ONLY)return void fermerPopup();o&&o.classList.remove("active"),n&&n.classList.add("active"),t.style=`border-left-color: ${a?a.couleur:"#009058"}`,t.dataset.statut=e[COLONNES_MAP.STATUT],t.dataset.isdone=!a&&a.isdone,t.dataset.currentTodo=e.id;const l=t.querySelector(".popup-title"),i=t.querySelector(".popup-content");t.querySelector(".popup-header").style=`background-color: ${a?a.couleur:"#009058"}`,l.textContent=e[COLONNES_MAP.DESCRIPTION]||"Nouvelle t√¢che";let r='<div class="field-row">';REF_PROJET?.length>0?(r+=`\n          <div class="field">\n            <label class="field-label">R√©f√©rence Projet</label>\n            <select class="field-select" onchange="mettreAJourChamp(${e.id}, '${COLONNES_MAP.REFERENCE_PROJET}', this.value, event)">`,REF_PROJET.forEach((t=>{r+=`<option value="${t}" ${e[COLONNES_MAP.REFERENCE_PROJET]===t?"selected":""}>${t}</option>`})),r+="</select>\n          </div>        \n      "):r+=`\n          <div class="field">\n            <label class="field-label">R√©f√©rence Projet</label>\n            <input type="text" class="field-input" value="${e[COLONNES_MAP.REFERENCE_PROJET]||""}" \n                  onchange="mettreAJourChamp(${e.id}, '${COLONNES_MAP.REFERENCE_PROJET}', this.value, event)">\n          </div>\n        `,r+=`\n        <div class="field">\n          <label class="field-label">Date limite</label>\n          <input type="date" class="field-input" \n                 value="${formatDateForInput(e[COLONNES_MAP.DEADLINE])}"\n                 onchange="mettreAJourChamp(${e.id}, '${COLONNES_MAP.DEADLINE}', this.value, event)">\n        </div>\n      </div>\n  \n      <div class="field-row">\n    `,COLONNES_MAP.TYPE&&(TYPES?.length>0?(r+=`\n            <div class="field">\n              <label class="field-label">Type</label>\n              <select class="field-select" onchange="mettreAJourChamp(${e.id}, '${COLONNES_MAP.TYPE}', this.value, event)">`,TYPES.forEach((t=>{r+=`<option value="${t}" ${e[COLONNES_MAP.TYPE]===t?"selected":""}>${t}</option>`})),r+="</select>\n            </div>        \n        "):r+=`\n            <div class="field">\n              <label class="field-label">Type</label>\n              <input type="text" class="field-input" value="${e[COLONNES_MAP.TYPE]||""}" \n                    onchange="mettreAJourChamp(${e.id}, '${COLONNES_MAP.TYPE}', this.value, event)">\n            </div>\n        `),COLONNES_MAP.RESPONSABLE&&(PERSONNES?.length>0?(r+=`\n            <div class="field">\n              <label class="field-label">Responsable</label>\n              <select class="field-select" onchange="mettreAJourChamp(${e.id}, '${COLONNES_MAP.RESPONSABLE}', this.value, event)">`,PERSONNES.forEach((t=>{r+=`<option value="${t}" ${e[COLONNES_MAP.RESPONSABLE]===t?"selected":""}>${t}</option>`})),r+="</select>\n            </div>        \n        "):r+=`\n            <div class="field">\n              <label class="field-label">Responsable</label>\n              <input type="text" class="field-input" value="${e[COLONNES_MAP.RESPONSABLE]||""}" \n                    onchange="mettreAJourChamp(${e.id}, '${COLONNES_MAP.RESPONSABLE}', this.value, event)">\n            </div>\n        `),r+=`\n      </div>\n      <div class="field">\n        <label class="field-label">Description</label>\n        <textarea class="field-textarea auto-expand" \n                  onchange="mettreAJourChamp(${e.id}, '${COLONNES_MAP.DESCRIPTION}', this.value, event)"\n                  oninput="this.style.height = ''; this.style.height = this.scrollHeight + 'px'">${e[COLONNES_MAP.DESCRIPTION]||""}</textarea>\n      </div>\n    `,COLONNES_MAP.NOTES&&(r+=`  \n        <div class="field">\n          <label class="field-label">Notes</label>\n          <textarea class="field-textarea auto-expand" \n                    onchange="mettreAJourChamp(${e.id}, '${COLONNES_MAP.NOTES}', this.value, event)"\n                    oninput="this.style.height = ''; this.style.height = this.scrollHeight + 'px'">${e[COLONNES_MAP.NOTES]||""}</textarea>\n        </div>\n      `),(COLONNES_MAP.CREE_LE||COLONNES_MAP.CREE_PAR)&&(r+=` \n        <div class="info-creation">\n          Cr√©√© ${COLONNES_MAP.CREE_LE?"le "+formatDate(e[COLONNES_MAP.CREE_LE]):""} ${COLONNES_MAP.CREE_PAR?"par "+(e[COLONNES_MAP.CREE_PAR]||"-"):""}\n        </div>\n      `),READ_ONLY||(r+=` \n        <div class="popup-actions">\n          <button class="popup-action-button bouton-supprimer" onclick="supprimerTodo(${e.id}, event)" \n                  title="Supprimer la t√¢che">üóëÔ∏è</button>\n        </div>\n      `),i.innerHTML=r,setTimeout((()=>{document.querySelectorAll(".auto-expand").forEach((e=>{e.style.height="",e.style.height=e.scrollHeight+"px"}))}),0),t.classList.add("visible")}function fermerPopup(){const e=document.getElementById("popup-todo"),t=e.dataset.currentTodo,o=document.querySelector(`[data-todo-id="${t}"]`);o&&o.classList.remove("active"),e.classList.remove("visible")}async function creerNouvelleTache(e){try{let t={[COLONNES_MAP.DESCRIPTION]:"Nouvelle t√¢che",[COLONNES_MAP.STATUT]:e};COLONNES_MAP.TYPE&&(t[COLONNES_MAP.TYPE]=""),COLONNES_MAP.REFERENCE_PROJET&&(t[COLONNES_MAP.REFERENCE_PROJET]=null),COLONNES_MAP.DERNIERE_MISE_A_JOUR&&(t[COLONNES_MAP.DERNIERE_MISE_A_JOUR]=(new Date).toISOString()),COLONNES_MAP.CREE_LE&&(t[COLONNES_MAP.CREE_LE]=(new Date).toISOString());const o=await TABLE_KANBAN.create({fields:t});if(o.id&&o.id>0){togglePopupTodo(await grist.fetchSelectedRecord(o.id))}}catch(e){console.error("Erreur cr√©ation:",e)}}async function supprimerTodo(e,t){if(t?.stopPropagation(),confirm("√ätes-vous s√ªr de vouloir supprimer cette t√¢che ?"))try{await TABLE_KANBAN.destroy(parseInt(e)),fermerPopup()}catch(e){console.error("Erreur suppression:",e)}}function afficherKanban(e){const t=document.getElementById("conteneur-kanban");t.innerHTML="",COLONNES_AFFICHAGE.forEach((e=>{const o=creerColonneKanban(e);t.appendChild(o)})),e?.length>0&&(e.forEach((e=>{const t=creerCarteTodo(e),o=document.querySelector(`.contenu-colonne[data-statut="${e[COLONNES_MAP.STATUT]}"]`);o&&o.insertBefore(t,o.firstChild)})),READ_ONLY||document.querySelectorAll(".contenu-colonne").forEach((e=>{new Sortable(e,{group:"kanban-todo",animation:150,onEnd:async function(t){const o=t.to.dataset.statut;if(o===t.from.dataset.statut){let e=t.item.dataset.deadline||"9999-12-31";if(t.oldIndex!==t.newIndex&&new Date(e)>=DEADLINE_PRIORITE){let t=DEADLINE_PRIORITE.getFullYear(),n=[];document.querySelectorAll(".contenu-colonne").forEach((a=>{a.getAttribute("data-statut")===o&&a.querySelectorAll(".carte").forEach((async o=>{e=o.getAttribute("data-deadline")||"9999-12-31",new Date(e)>=DEADLINE_PRIORITE&&(e=`${t}-01-01`,o.setAttribute("data-deadline",e),t+=1,n.push({id:parseInt(o.getAttribute("data-todo-id")),fields:{[COLONNES_MAP.DEADLINE]:e}}))}))}));try{await TABLE_KANBAN.update(n)}catch(e){console.error("Erreur mise √† jour statut:",e)}}}else try{await mettreAJourChamp(t.item.dataset.todoId,COLONNES_MAP.STATUT,o)}catch(e){console.error("Erreur mise √† jour statut:",e)}trierTodo(e)}}),trierTodo(e)})),document.querySelectorAll(".colonne-kanban").forEach(mettreAJourCompteur))}function ShowConfig(e){const t=document.getElementById("popup-todo"),o=document.getElementById("conteneur-kanban"),n=document.getElementById("config-kanban");e?(t.classList.remove("visible"),o.classList.remove("visible"),n.classList.add("visible"),document.getElementById("liste-colonnes").value=JSON.stringify(COLONNES_AFFICHAGE,null,2),document.getElementById("liste-ref").value=REF_PROJET_RAW,document.getElementById("liste-personnes").value=PERSONNES_RAW,document.getElementById("liste-types").value=TYPES_RAW,document.getElementById("card-rotation").checked=ROTATE_CARTE,document.getElementById("card-compact").checked=CARTE_COMPACT,document.getElementById("is-readonly").checked=READ_ONLY,setTimeout((()=>{document.querySelectorAll(".auto-expand").forEach((e=>{e.style.height="",e.style.height=e.scrollHeight+"px"}))}),0)):(t.classList.remove("visible"),o.classList.add("visible"),n.classList.remove("visible"))}function closeConfig(){ShowConfig(!1)}async function saveOption(){try{const e=document.getElementById("liste-colonnes").value;COLONNES_AFFICHAGE=e&&0!==e.trim().length?JSON.parse(e):COLONNES_AFFICHAGE_DEFAUT,grist.widgetApi.setOption("colonnes",COLONNES_AFFICHAGE),REF_PROJET_RAW=document.getElementById("liste-ref").value,grist.widgetApi.setOption("ref",REF_PROJET_RAW),REF_PROJET=await getLookUpData(REF_PROJET_RAW),PERSONNES_RAW=document.getElementById("liste-personnes").value,grist.widgetApi.setOption("personnes",PERSONNES_RAW),PERSONNES=await getLookUpData(PERSONNES_RAW),TYPES_RAW=document.getElementById("liste-types").value,grist.widgetApi.setOption("types",TYPES_RAW),TYPES=await getLookUpData(TYPES_RAW),ROTATE_CARTE=document.getElementById("card-rotation").checked,grist.widgetApi.setOption("rotation",ROTATE_CARTE),CARTE_COMPACT=document.getElementById("card-compact").checked,grist.widgetApi.setOption("compact",CARTE_COMPACT),READ_ONLY=document.getElementById("is-readonly").checked,grist.widgetApi.setOption("readonly",READ_ONLY)}catch(e){console.error("Erreur sauvegarde des options:",e)}}async function getLookUpData(e){if(e&&0!==e.trim().length){if(e.startsWith("$")){let t=(e=e.substring(1)).split(".");if(1===t.length){let e=await grist.docApi.fetchTable(t[0]),o=Object.keys(e||{}).filter((e=>"id"!==e&&"manualSort"!==e));return o.length>0?[""].concat(e[o[0]].filter((e=>e.length>0)).sort()):[]}if(t.length>1){let e=await grist.docApi.fetchTable(t[0]);return e=e[t[1]],e?[""].concat(e.filter((e=>e.length>0)).sort()):[]}return[e]}return[""].concat(e.split(";").filter((e=>e.length>0)).sort())}return[]}grist.ready({requiredAccess:"full",columns:[{name:"TYPE",title:"Type de t√¢che",type:"Any",optional:!0},{name:"DESCRIPTION",title:"Description t√¢che",type:"Any"},{name:"DEADLINE",title:"Date cible",type:"Date"},{name:"STATUT",title:"Statut t√¢che",type:"Any"},{name:"REFERENCE_PROJET",title:"R√©f√©rence associ√©e",type:"Any"},{name:"NOTES",title:"Notes compl√©mentaires",type:"Any",optional:!0},{name:"RESPONSABLE",title:"T√¢che assign√©e √†",type:"Any",optional:!0},{name:"CREE_PAR",title:"T√¢che cr√©√©e par",type:"Any",optional:!0},{name:"CREE_LE",title:"T√¢che cr√©√©e le",type:"DateTime",optional:!0},{name:"DERNIERE_MISE_A_JOUR",title:"Mis √† jour le",type:"DateTime",optional:!0},{name:"COULEUR",title:"Couleur carte",type:"Any",optional:!0}],onEditOptions(){ShowConfig(!0)}}),grist.onOptions((async function(e,t){COLONNES_AFFICHAGE=(e=e||{}).colonnes||COLONNES_AFFICHAGE_DEFAUT,REF_PROJET_RAW=e.ref||"",REF_PROJET=await getLookUpData(REF_PROJET_RAW),PERSONNES_RAW=e.personnes||"",PERSONNES=await getLookUpData(PERSONNES_RAW),TYPES_RAW=e.types||"",TYPES=await getLookUpData(TYPES_RAW),ROTATE_CARTE=void 0===e.rotation||e.rotation,CARTE_COMPACT=void 0!==e.compact&&e.compact,READ_ONLY=void 0!==e.readonly&&e.readonly;const o=document.querySelectorAll(".carte");ROTATE_CARTE?o.forEach((e=>{e.classList.remove("norotate")})):o.forEach((e=>{e.classList.add("norotate")})),CARTE_COMPACT?(o.forEach((e=>{e.classList.add("compact")})),document.querySelectorAll(".bouton-ajouter-entete").forEach((e=>{e.classList.add("compact")})),document.querySelectorAll(".bouton-ajouter").forEach((e=>{e.classList.add("compact")}))):(o.forEach((e=>{e.classList.remove("compact")})),document.querySelectorAll(".bouton-ajouter-entete").forEach((e=>{e.classList.remove("compact")})),document.querySelectorAll(".bouton-ajouter").forEach((e=>{e.classList.remove("compact")}))),ShowConfig(!1)})),grist.onRecords(((e,t)=>{console.log("T√¢ches re√ßues:",e),COLONNES_MAP=t,afficherKanban(e)})),window.toggleColonne=toggleColonne,window.togglePopupTodo=togglePopupTodo,window.fermerPopup=fermerPopup,window.mettreAJourChamp=mettreAJourChamp,window.creerNouvelleTache=creerNouvelleTache,window.supprimerTodo=supprimerTodo,document.addEventListener("keydown",(e=>{"Escape"===e.key&&fermerPopup()})),document.addEventListener("click",(e=>{const t=document.getElementById("popup-todo");if(t.classList.contains("visible")){t.querySelector(".popup-content").contains(e.target)||e.target.closest(".carte")||e.target.closest(".popup-header")||fermerPopup()}}));